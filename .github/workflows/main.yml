name: Set Start Date When Issue Is Assigned

on:
  issues:
    types: [assigned]

jobs:
  set-start-date:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: read
      pull-requests: read

    steps:
      - name: Get project item for this issue
        id: find_item
        uses: actions/github-script@v7
        with:
          script: |
            const issueNodeId = context.payload.issue.node_id;

            const query = `
              query($id: ID!) {
                node(id: $id) {
                  ... on Issue {
                    projectItems(first: 20) {
                      nodes {
                        id
                        project {
                          id
                          title
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, { id: issueNodeId });

            const targetProjectId = "YOUR_PROJECT_ID"; // <— fill in
            const item = result.node.projectItems.nodes.find(
              node => node.project.id === targetProjectId
            );

            if (!item) {
              core.setFailed("Issue is not in the target project.");
              return;
            }

            core.setOutput("itemId", item.id);

      - name: Set Start Date field
        uses: actions/github-script@v7
        with:
          script: |
            const itemId = "${{ steps.find_item.outputs.itemId }}";
            const fieldId = "YOUR_START_DATE_FIELD_ID"; // <— fill in
            const projectId = "YOUR_PROJECT_ID";        // <— fill in

            const mutation = `
              mutation($item: ID!, $field: ID!, $project: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    itemId: $item,
                    fieldId: $field,
                    projectId: $project,
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            const today = new Date().toISOString().split('T')[0];

            await github.graphql(mutation, {
              item: itemId,
              field: fieldId,
              project: projectId,
              value: { date: today }
            });
